---
title: "Extracting data from fotmob"
author: "Tony ElHabr"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extracting data from fotmob}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message=FALSE,
  warning=FALSE
)
```

## Overview

This package is designed to allow users to extract various world football results and player statistics from the following popular football (soccer) data sites:

-   [FBref](https://fbref.com/en/)
-   [Transfermarkt](https://www.transfermarkt.com/)
-   [Understat](https://understat.com/)
-   [Fotmob](https://www.fotmob.com/)

## Installation

You can install the `worldfootballR` package from github with:

```{r gh-installation, eval=FALSE}
# install.packages("devtools")
devtools::install_github("JaseZiv/worldfootballR")
```

```{r load_libs, warning=FALSE, message=FALSE}
library(worldfootballR)
```

------------------------------------------------------------------------

## Usage

Package vignettes have been built to help you get started with the package.

-   For functions to extract data from FBref, see [here](https://jaseziv.github.io/worldfootballR/articles/extract-fbref-data.html)
-   For functions to extract data from Transfermarkt, see [here](https://jaseziv.github.io/worldfootballR/articles/extract-transfermarkt-data.html)
-   For functions to extract data from Understat, see [here](https://jaseziv.github.io/worldfootballR/articles/extract-understat-data.html)
-   For functions to extract data for international matches from FBref, see [here](https://jaseziv.github.io/worldfootballR/articles/fbref-data-internationals.html)

This vignette will cover the functions to extract data from understat.com

------------------------------------------------------------------------

## fotmob Helper Functions

There are currently no helper functions for fotmob functions.

------------------------------------------------------------------------

## League Season-Level Data

fotmob has data for just about every league that you can think of, including all of the Big 5 leagues. However, no functions currently exist to retrieve entire season's worth of data.

### Match Results

fotmob lists data for all leagues by date. Use `fotmob_get_matches_by_date` to select matches occurring on specific day(s) and filter down to the league(s) that you care about.

```{r fotmob_get_matches_by_date}
library(dplyr)
library(tidyr)
results <- fotmob_get_matches_by_date(date = c("20210925", "20210926"))
dplyr::glimpse(results)
```

```{r fotmob_match_ids}
filtered_results <- results %>%
  dplyr::select(primary_id, ccode, league_name = name, matches) %>%
  dplyr::filter(league_name == "Premier League", ccode == "ENG")

# one way of getting data out of the results
unnested_results <- filtered_results %>% 
  tidyr::unnest_longer(matches)

match_ids <- unnested_results %>% 
  dplyr::pull(matches) %>% 
  dplyr::pull(id)
match_ids
```

Note that fotmob returns nested data.frames or lists for some elements. Nested components have camel case names.

```{r fotmob_unnested_results}
unnested_results %>% 
  dplyr::pull(matches) %>% 
  dplyr::glimpse()
```

------------------------------------------------------------------------

## Match-Level Data

### Match Shooting Locations

To get shooting locations for an individual match along with expected goals (xG), expected goals on target (xGoT), etc., use the `fotmob_get_match_details()` function.

```{r fotmob_match_details}
fotmob_matches <- c(3609994, 3610132)
match_details <- fotmob_get_match_details(fotmob_matches)
dplyr::glimpse(match_details)
```

```{r fotmob_match_shots}
match_shots <- match_details %>% 
  dplyr::select(
    match_id,
    shots
  ) %>% 
  tidyr::unnest(shots)
dplyr::glimpse(match_shots)
```

There is one nested element in the returned data.frame for `on_goal_shot`. As with the nested elements returned by `fotmob_get_matches_by_date`, columns in nested elements have camel case names. (Here, it's only `zoomRatio`.)

```{r on_goal_shots}
match_shots %>% 
  select(on_goal_shot) %>% 
  tidyr::unnest_wider(
    on_goal_shot
  )
```

Be very careful with interpreting `x` and `y` from `on_goal_shot`. They're not on the same scale as `x` and `y` in the top-level of the result returned from `fotmob_get_match_details`!

### Players

You can also extract players from matches with the `fotmob_get_match_players()` function.

```{r fotmob_players}
players <- fotmob_get_match_players(fotmob_matches)
dplyr::glimpse(players)
```

```{r salah_shotmap}
salah <- players %>% dplyr::filter(id == "292462")
salah_shotmap <- salah %>% 
  dplyr::select(player_id = id, shotmap) %>% 
  tidyr::unnest(shotmap)
dplyr::glimpse(salah_shotmap)
```

```{r salah_stats}
salah_stats <- salah %>% 
  dplyr::select(player_id = id, stats) %>% 
  tidyr::unnest(stats)
dplyr::glimpse(salah_stats)
```
